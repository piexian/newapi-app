name: Issue AI Triage

on:
  issues:
    types: [opened]

jobs:
  triage:
    runs-on: ubuntu-latest
    permissions:
      issues: write
    if: ${{ github.repository == vars.ALLOWED_REPO }}

    steps:
      - name: AI classify + Chinese summary
        id: ai
        env:
          API_BASE: ${{ secrets.PROXY_API_BASE }}
          API_KEY: ${{ secrets.PROXY_API_KEY }}
          MODEL: ${{ secrets.PROXY_MODEL }}
          TITLE: ${{ github.event.issue.title }}
          BODY: ${{ github.event.issue.body }}
        run: |
          set -euo pipefail

          ALLOWED_LABELS_JSON='["bug","enhancement","question","documentation","chore"]'

          PAYLOAD="$(jq -n \
            --arg model "$MODEL" \
            --arg title "$TITLE" \
            --arg body "$BODY" \
            --arg allowed "$ALLOWED_LABELS_JSON" \
            '{
              model: $model,
              messages: [
                {role:"system", content:"Return only valid JSON. No markdown."},
                {role:"user", content:
                  "ä½ æ˜¯ä¸€ä¸ª GitHub Issue ç®¡ç†åŠ©æ‰‹ã€‚\n" +
                  "è¦æ±‚ï¼š\n" +
                  "- ä¸ç®¡åŸæ–‡è¯­è¨€æ˜¯ä»€ä¹ˆï¼Œsummary_zh å¿…é¡»æ˜¯ä¸­æ–‡ï¼Œä¸€æ®µè¯\n" +
                  "- labels åªèƒ½ä»å…è®¸é›†åˆä¸­é€‰æ‹© 0~3 ä¸ª\n" +
                  "- ä»…è¾“å‡º JSONï¼Œä¸è¦å¤šä½™æ–‡æœ¬\n" +
                  "è¾“å‡ºæ ¼å¼ï¼š{\"summary_zh\":\"...\",\"labels\":[\"...\"]}\n\n" +
                  "å…è®¸é›†åˆï¼š\n" + $allowed + "\n\n" +
                  "Issue æ ‡é¢˜ï¼š\n" + $title + "\n\n" +
                  "Issue æ­£æ–‡ï¼š\n" + $body
                }
              ],
              temperature: 0.2
            }')"

          RESP="$(curl -sS "${API_BASE}/chat/completions" \
            -H "Authorization: Bearer ${API_KEY}" \
            -H "Content-Type: application/json" \
            -d "$PAYLOAD")"

          CONTENT="$(echo "$RESP" | jq -r '.choices[0].message.content // empty')"
          SUMMARY="$(echo "$CONTENT" | jq -r '.summary_zh // empty')"
          LABELS="$(echo "$CONTENT" | jq -c '.labels // []')"

          [ -n "$SUMMARY" ] || exit 1

          {
            echo "summary<<EOF"
            echo "$SUMMARY"
            echo "EOF"
            echo "labels=$LABELS"
          } >> "$GITHUB_OUTPUT"

      - name: Apply labels
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_REPO: ${{ github.repository }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          LABELS_JSON: ${{ steps.ai.outputs.labels }}
        run: |
          set -euo pipefail

          tmp="$(mktemp)"
          gh label list --json name --limit 200 | jq -r '.[].name' > "$tmp"

          echo "$LABELS_JSON" | jq -r '.[]' | while read -r label; do
            [ -n "$label" ] || continue

            if ! grep -Fxq "$label" "$tmp"; then
              gh label create "$label" --color ededed --description auto >/dev/null
              echo "$label" >> "$tmp"
            fi

            gh issue edit "$ISSUE_NUMBER" --add-label "$label" >/dev/null
          done

      - name: Comment summary
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_REPO: ${{ github.repository }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          SUMMARY: ${{ steps.ai.outputs.summary }}
        run: |
          set -euo pipefail
          gh issue comment "$ISSUE_NUMBER" --body "ğŸ¤– **æ‘˜è¦ï¼ˆä¸­æ–‡ï¼‰**\n\n$SUMMARY"
